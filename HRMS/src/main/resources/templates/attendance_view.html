<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d@0.1.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #121212; /* Dark background */
            color: #e0e0e0; /* Light text */
        }

        /* Prevent scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        .container {
            /* Removed min-h-screen from container as well */
        }

        .card {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
            background-color: #1e1e1e; /* Dark card background */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Darker shadow */
            position: relative;
        }

        .card:not(.expanded):hover { /* Apply hover effect only when not expanded */
            transform: translateY(-5px) rotateX(5deg);
            box-shadow: 0 20px 25px -5px rgba(255, 165, 0, 0.2), 0 10px 10px -5px rgba(255, 165, 0, 0.1); /* Orange hover shadow */
        }

        /* Keyframes for the "pop-in" animation */
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.7); /* Starts smaller and faded */
            }
            70% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05); /* Slightly overshoots for a pop effect */
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1); /* Settles at normal size */
            }
        }

        .expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            /* Initial state for animation */
            opacity: 0; 
            transform: translate(-50%, -50%) scale(0.7); /* Start smaller */
            
            z-index: 1000;
            width: 90%;
            max-width: 900px;
            height: auto;
            max-height: 90vh; 
            overflow-y: auto;
            background-color: #212121; /* Slightly lighter dark background for modal */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 165, 0, 0.3); /* Darker shadow with subtle orange border */
            padding: 24px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Apply the pop-in animation */
            animation: pop-in 0.4s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            transition: none; /* Disable other transitions when expanded */
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            z-index: 900;
            display: none;
            opacity: 0; /* Start faded */
            transition: opacity 0.3s ease; /* Smooth fade-in */
        }
        .overlay.active {
            display: block;
            opacity: 1;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background-color: #333333; /* Darker grey for button */
            color: #ff8c00; /* Orange 'X' */
            border-radius: 50%;
            padding: 8px 12px;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #ff8c00; /* Orange border for button */
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            opacity: 1;
            background-color: #ff8c00; /* Orange background on hover */
            color: #121212; /* Dark text on hover */
            transform: scale(1.1);
        }

        .date-picker {
            display: none; /* Hidden by default */
            margin-top: 10px;
            padding: 10px;
            background-color: #2a2a2a; /* Slightly lighter dark background for picker */
            border-radius: 6px;
            border: 1px solid #424242; /* Subtle border */
        }

        .expanded .date-picker {
            display: block; /* Shown when expanded */
        }

        .date-picker label {
            color: #ff8c00; /* Orange label */
            margin-bottom: 5px;
            display: block;
            font-size: 0.9em;
            font-weight: bold;
        }

        .date-picker input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ff8c00; /* Orange border for inputs */
            border-radius: 4px;
            background-color: #303030; /* Darker input background */
            color: #e0e0e0; /* Light text in inputs */
            box-sizing: border-box;
            cursor: pointer; /* Change cursor to pointer for date inputs */
        }
        
        /* Style for date picker dropdown arrows in dark theme */
        .date-picker input[type="date"]::-webkit-calendar-picker-indicator,
        .date-picker input[type="week"]::-webkit-calendar-picker-indicator,
        .date-picker input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Invert color for dark theme visibility */
        }


        .chart-container {
            height: 300px; /* Default height for mini cards */
            width: 100%;
            margin-top: 1rem;
            position: relative;
        }

        .expanded .chart-container {
            height: 450px; /* Taller when expanded */
            flex-grow: 1; /* Allow chart container to grow in expanded view */
        }

        /* Adjust chart titles and tooltips for better visibility in dark theme */
        .chartjs-tooltip {
            background-color: rgba(30, 30, 30, 0.9) !important; /* Darker tooltip background */
            border: 1px solid #ff8c00 !important; /* Orange border */
            color: #e0e0e0 !important; /* Light text */
            border-radius: 6px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .chartjs-tooltip-header {
            color: #ff8c00 !important; /* Orange header text */
            padding-bottom: 5px !important;
            margin-bottom: 5px !important;
            border-bottom: 1px solid #424242 !important;
        }

        .chartjs-tooltip-body {
            color: #e0e0e0 !important;
        }

        /* Custom scrollbar for expanded card if content overflows */
        .expanded::-webkit-scrollbar {
            width: 8px;
        }

        .expanded::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }

        .expanded::-webkit-scrollbar-thumb {
            background: #ff8c00;
            border-radius: 10px;
        }

        .expanded::-webkit-scrollbar-thumb:hover {
            background: #e67e00;
        }
    </style>
</head>
<body class="container mx-auto px-4 py-8">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-300 mb-8">Attendance Dashboard</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card rounded-lg p-6 cursor-pointer relative" onclick="expandCard(this, 'daily')">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-400">Daily Attendance</h2>
                    <i class="fas fa-calendar-day text-orange-500 text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4">Today's attendance overview</p>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="date-picker">
                    <label for="dailyDate" class="block text-sm font-medium text-gray-400 mb-2">Select Date:</label>
                    <input type="date" id="dailyDate" class="w-full p-2 border rounded-md" onchange="updateDailyChart()" onclick="event.stopPropagation()">
                </div>
            </div>

            <div class="card rounded-lg p-6 cursor-pointer relative" onclick="expandCard(this, 'weekly')">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-400">Weekly Attendance</h2>
                    <i class="fas fa-calendar-week text-orange-500 text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4">This week's attendance overview</p>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="date-picker">
                    <label for="weeklyDate" class="block text-sm font-medium text-gray-400 mb-2">Select Week:</label>
                    <input type="week" id="weeklyDate" class="w-full p-2 border rounded-md" onchange="updateWeeklyChart()" onclick="event.stopPropagation()">
                </div>
            </div>

            <div class="card rounded-lg p-6 cursor-pointer relative" onclick="expandCard(this, 'monthly')">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-400">Monthly Attendance</h2>
                    <i class="fas fa-calendar-alt text-orange-500 text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4">This month's attendance overview</p>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="date-picker">
                    <label for="monthlyDate" class="block text-sm font-medium text-gray-400 mb-2">Select Month:</label>
                    <input type="month" id="monthlyDate" class="w-full p-2 border rounded-md" onchange="updateMonthlyChart()" onclick="event.stopPropagation()">
                </div>
            </div>
        </div>
    </div>

    <div class="overlay"></div> 

   <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d@0.1.0"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #121212; /* Dark background */
            color: #e0e0e0; /* Light text */
        }

        /* Prevent scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        .card {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
            background-color: #1e1e1e; /* Dark card background */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Darker shadow */
            position: relative;
        }

        .card:not(.expanded):hover { /* Apply hover effect only when not expanded */
            transform: translateY(-5px) rotateX(5deg);
            box-shadow: 0 20px 25px -5px rgba(255, 165, 0, 0.2), 0 10px 10px -5px rgba(255, 165, 0, 0.1); /* Orange hover shadow */
        }

        /* Keyframes for the "pop-in" animation */
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.7); /* Starts smaller and faded */
            }
            70% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05); /* Slightly overshoots for a pop effect */
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1); /* Settles at normal size */
            }
        }

        .expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            /* Initial state for animation */
            opacity: 0; 
            transform: translate(-50%, -50%) scale(0.7); /* Start smaller */
            
            z-index: 1000;
            width: 90%;
            max-width: 900px;
            height: auto; /* Let content dictate height */
            max-height: 90vh; /* Max height to prevent overflow on smaller screens */
            overflow-y: auto; /* Enable scrolling if content overflows */
            background-color: #212121; /* Slightly lighter dark background for modal */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 165, 0, 0.3); /* Darker shadow with subtle orange border */
            padding: 24px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Apply the pop-in animation */
            animation: pop-in 0.4s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            transition: none; /* Disable other transitions when expanded to rely on animation */
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            z-index: 900;
            display: none; /* Hidden by default */
            opacity: 0; /* Start faded */
            transition: opacity 0.3s ease; /* Smooth fade-in */
        }
        .overlay.active {
            display: block;
            opacity: 1;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background-color: #333333; /* Darker grey for button */
            color: #ff8c00; /* Orange 'X' */
            border-radius: 50%;
            padding: 8px 12px;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #ff8c00; /* Orange border for button */
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            opacity: 1;
            background-color: #ff8c00; /* Orange background on hover */
            color: #121212; /* Dark text on hover */
            transform: scale(1.1);
        }

        .date-picker {
            display: none; /* Hidden by default */
            margin-top: 10px;
            padding: 10px;
            background-color: #2a2a2a; /* Slightly lighter dark background for picker */
            border-radius: 6px;
            border: 1px solid #424242; /* Subtle border */
        }

        .expanded .date-picker {
            display: block; /* Shown when expanded */
        }

        .date-picker label {
            color: #ff8c00; /* Orange label */
            margin-bottom: 5px;
            display: block;
            font-size: 0.9em;
            font-weight: bold;
        }

        .date-picker input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ff8c00; /* Orange border for inputs */
            border-radius: 4px;
            background-color: #303030; /* Darker input background */
            color: #e0e0e0; /* Light text in inputs */
            box-sizing: border-box;
            cursor: pointer; /* Change cursor to pointer for date inputs */
        }
        
        /* Style for date picker dropdown arrows in dark theme */
        .date-picker input[type="date"]::-webkit-calendar-picker-indicator,
        .date-picker input[type="week"]::-webkit-calendar-picker-indicator,
        .date-picker input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Invert color for dark theme visibility */
        }


        .chart-container {
            height: 300px; /* Default height for mini cards */
            width: 100%;
            margin-top: 1rem;
            position: relative;
        }

        .expanded .chart-container {
            height: 450px; /* Taller when expanded */
            flex-grow: 1; /* Allow chart container to grow in expanded view */
        }

        /* Adjust chart titles and tooltips for better visibility in dark theme */
        .chartjs-tooltip {
            background-color: rgba(30, 30, 30, 0.9) !important; /* Darker tooltip background */
            border: 1px solid #ff8c00 !important; /* Orange border */
            color: #e0e0e0 !important; /* Light text */
            border-radius: 6px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .chartjs-tooltip-header {
            color: #ff8c00 !important; /* Orange header text */
            padding-bottom: 5px !important;
            margin-bottom: 5px !important;
            border-bottom: 1px solid #424242 !important;
        }

        .chartjs-tooltip-body {
            color: #e0e0e0 !important;
        }

        /* Custom scrollbar for expanded card if content overflows */
        .expanded::-webkit-scrollbar {
            width: 8px;
        }

        .expanded::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }

        .expanded::-webkit-scrollbar-thumb {
            background: #ff8c00;
            border-radius: 10px;
        }

        .expanded::-webkit-scrollbar-thumb:hover {
            background: #e67e00;
        }
    </style>
</head>
<body class="container mx-auto px-4 py-8">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-300 mb-8">Attendance Dashboard</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card rounded-lg p-6 cursor-pointer relative" onclick="expandCard(this, 'daily')">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-400">Daily Attendance</h2>
                    <i class="fas fa-calendar-day text-orange-500 text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4">Today's attendance overview</p>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="date-picker">
                    <label for="dailyDate" class="block text-sm font-medium text-gray-400 mb-2">Select Date:</label>
                    <input type="date" id="dailyDate" class="w-full p-2 border rounded-md" onchange="updateDailyChart()" onclick="event.stopPropagation()">
                </div>
            </div>

            <div class="card rounded-lg p-6 cursor-pointer relative" onclick="expandCard(this, 'weekly')">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-400">Weekly Attendance</h2>
                    <i class="fas fa-calendar-week text-orange-500 text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4">This week's attendance overview</p>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="date-picker">
                    <label for="weeklyDate" class="block text-sm font-medium text-gray-400 mb-2">Select Week:</label>
                    <input type="week" id="weeklyDate" class="w-full p-2 border rounded-md" onchange="updateWeeklyChart()" onclick="event.stopPropagation()">
                </div>
            </div>

            <div class="card rounded-lg p-6 cursor-pointer relative" onclick="expandCard(this, 'monthly')">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-400">Monthly Attendance</h2>
                    <i class="fas fa-calendar-alt text-orange-500 text-2xl"></i>
                </div>
                <p class="text-gray-500 mb-4">This month's attendance overview</p>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="date-picker">
                    <label for="monthlyDate" class="block text-sm font-medium text-gray-400 mb-2">Select Month:</label>
                    <input type="month" id="monthlyDate" class="w-full p-2 border rounded-md" onchange="updateMonthlyChart()" onclick="event.stopPropagation()">
                </div>
            </div>
        </div>
    </div>

    <div class="overlay"></div>

    <script>
        // Global variable to keep track of the currently expanded card
        let currentExpandedCard = null;
        let currentChartType = ''; // To remember which chart type is expanded

        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date();
            document.getElementById('dailyDate').valueAsDate = today;
            
            // For type="week" and type="month", their value format is specific (YYYY-Www, YYYY-MM)
            document.getElementById('weeklyDate').value = getWeekNumber(today); 
            document.getElementById('monthlyDate').value = today.toISOString().slice(0, 7);

            // Initialize charts with data from backend
            initDailyChart();
            initWeeklyChart();
            initMonthlyChart();

            // Add event listener to close the card when clicking on the overlay
            document.querySelector('.overlay').addEventListener('click', function() {
                closeExpandedCard();
            });
        });

        // Helper to get week number in YYYY-Www format for input type="week"
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            // Return array of year and week number
            return d.getUTCFullYear() + '-W' + String(weekNo).padStart(2, '0');
        }

        function expandCard(card, type) {
            // Close the currently expanded card if a different one is clicked
            if (currentExpandedCard && currentExpandedCard !== card) {
                closeExpandedCard();
            }

            // Toggle expansion: if clicking the same card, close it
            if (currentExpandedCard === card) {
                closeExpandedCard();
                return;
            }

            currentExpandedCard = card;
            currentChartType = type;
            card.classList.add('expanded');
            
            // Show the overlay and prevent body scrolling
            const overlay = document.querySelector('.overlay');
            overlay.classList.add('active'); // Use class for active state
            document.body.classList.add('modal-open');

            let closeBtn = card.querySelector('.close-btn');
            if (!closeBtn) {
                closeBtn = document.createElement('button'); // Changed to button for better semantics
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '<i class="fas fa-times"></i>'; // Font Awesome icon
                closeBtn.onclick = function(e) {
                    e.stopPropagation(); // Prevent card click event from bubbling up
                    closeExpandedCard();
                };
                card.appendChild(closeBtn);
            }
            
            // Resize chart in expanded view after CSS animation completes
            // The 0.4s animation duration means 400ms. A slight delay ensures elements are in place.
            setTimeout(() => {
                if (type === 'daily' && dailyChart) {
                    dailyChart.resize();
                } else if (type === 'weekly' && weeklyChart) {
                    weeklyChart.resize();
                } else if (type === 'monthly' && monthlyChart) {
                    monthlyChart.resize();
                }
            }, 400); // Match or slightly exceed CSS animation duration
        }

        function closeExpandedCard() {
            if (!currentExpandedCard) return;

            const closeBtn = currentExpandedCard.querySelector('.close-btn');
            if (closeBtn) {
                currentExpandedCard.removeChild(closeBtn);
            }

            currentExpandedCard.classList.remove('expanded');
            
            // Hide the overlay and allow body scrolling
            const overlay = document.querySelector('.overlay');
            overlay.classList.remove('active');
            document.body.classList.remove('modal-open');

            // Resize chart back to mini size after CSS transition (if any)
            // This is important if you have different sizes for mini and expanded charts.
            setTimeout(() => {
                if (currentChartType === 'daily' && dailyChart) {
                    dailyChart.resize();
                } else if (currentChartType === 'weekly' && weeklyChart) {
                    weeklyChart.resize();
                } else if (currentChartType === 'monthly' && monthlyChart) {
                    monthlyChart.resize();
                }
            }, 300); // A shorter delay might be fine as it's returning to original size

            currentExpandedCard = null;
            currentChartType = '';
        }

        // Initialize Charts
        let dailyChart, weeklyChart, monthlyChart;

        async function initDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            try {
                // TOKEN: Replace with your actual JWT token from session storage or wherever you store it
                const token = localStorage.getItem('jwtToken'); // Example: get from localStorage
                const selectedDate = document.getElementById('dailyDate').value; // Get the initial date
                const response = await fetch(`/api/attendance/daily?date=${selectedDate}`, {
                    headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (!response.ok) {
                    console.error('Failed to fetch daily attendance:', response.status);
                    ctx.font = "16px Arial";
                    ctx.fillStyle = "#e0e0e0";
                    ctx.fillText("Error loading data", 10, 50);
                    return;
                }
                const data = await response.json();
                const workedHours = data.workedHours || 0;
                const targetHours = data.targetHours || 8;
                const percentage = targetHours > 0 ? Math.min(100, (workedHours / targetHours) * 100) : 0;
                const isOnLeave = data.isOnLeave || false;
                const adminReset = data.adminReset || false;


                if (dailyChart) dailyChart.destroy(); 

                dailyChart = new Chart(ctx, {
                    type: 'doughnut',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: ['Worked Hours', 'Remaining'],
                        datasets: [{
                            data: [workedHours, Math.max(0, targetHours - workedHours)],
                            backgroundColor: [
                                'rgba(255, 165, 0, 0.8)', // Orange
                                'rgba(100, 100, 100, 0.3)' // Darker gray
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e0e0e0'
                                }
                            },
                            datalabels: {
                                formatter: (value, context) => {
                                    if (context.dataIndex === 0) { // Only show for worked hours
                                        return `${value.toFixed(1)}h`;
                                    }
                                    return ''; // Hide for remaining hours
                                },
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: (context) => {
                                        if (isOnLeave) return `On Leave`;
                                        if (adminReset) return `Admin Reset`;
                                        return `Attendance for ${new Date(selectedDate).toLocaleDateString()}`;
                                    },
                                    label: (context) => {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.toFixed(1) + 'h';
                                        return label;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `Today: ${percentage.toFixed(1)}% of target`,
                                color: '#e0e0e0',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        cutout: '70%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching daily attendance:', error);
                ctx.font = "16px Arial";
                ctx.fillStyle = "#e0e0e0";
                ctx.fillText("Error loading data", 10, 50);
            }
        }

        async function updateDailyChart() {
            const date = document.getElementById('dailyDate').value;
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/attendance/daily?date=${date}`, {
                     headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (!response.ok) {
                    console.error('Failed to fetch daily attendance for date:', response.status);
                    return;
                }
                const data = await response.json();
                const workedHours = data.workedHours || 0;
                const targetHours = data.targetHours || 8;
                const percentage = targetHours > 0 ? Math.min(100, (workedHours / targetHours) * 100) : 0;
                const isOnLeave = data.isOnLeave || false;
                const adminReset = data.adminReset || false;

                dailyChart.data.datasets[0].data = [workedHours, Math.max(0, targetHours - workedHours)];
                dailyChart.options.plugins.title.text = `${new Date(date).toLocaleDateString()}: ${percentage.toFixed(1)}% of target`;
                
                // Update tooltip callbacks to reflect new data (leave/reset status)
                dailyChart.options.plugins.tooltip.callbacks.title = (context) => {
                    if (isOnLeave) return `On Leave`;
                    if (adminReset) return `Admin Reset`;
                    return `Attendance for ${new Date(date).toLocaleDateString()}`;
                };

                dailyChart.update();
            } catch (error) {
                console.error('Error fetching daily attendance for date:', error);
            }
        }

        async function initWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            try {
                const token = localStorage.getItem('jwtToken');
                const currentWeek = document.getElementById('weeklyDate').value; 
                const response = await fetch(`/api/attendance/weekly?week=${currentWeek}`, {
                     headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (!response.ok) {
                    console.error('Failed to fetch weekly attendance:', response.status);
                    ctx.font = "16px Arial";
                    ctx.fillStyle = "#e0e0e0";
                    ctx.fillText("Error loading data", 10, 50);
                    return;
                }
                const data = await response.json();
                
                const days = data.days || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const hours = data.hours || Array(days.length).fill(0);
                const leaveStatus = data.leaveStatus || Array(days.length).fill(false);
                const adminResetStatus = data.adminResetStatus || Array(days.length).fill(false);


                const weeklyTargetHours = days.length * 8; // Assuming 8 hours per day for all displayed days
                const weeklyTotal = hours.reduce((sum, hour) => sum + hour, 0);
                const percentage = weeklyTargetHours > 0 ? Math.min(100, (weeklyTotal / weeklyTargetHours) * 100) : 0;

                if (weeklyChart) weeklyChart.destroy();
                weeklyChart = new Chart(ctx, {
                    type: 'bar',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: days,
                        datasets: [
                            {
                                label: 'Hours Worked',
                                data: hours,
                                backgroundColor: 'rgba(255, 165, 0, 0.7)',
                                borderColor: 'rgba(255, 165, 0, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'On Leave',
                                data: leaveStatus.map(status => status ? 8 : 0), // Assuming 8 hours for leave display
                                backgroundColor: 'rgba(255, 99, 132, 0.6)', // Red for leave
                                stack: 'dailyHours', // Stack with worked hours
                                borderWidth: 0
                            },
                            {
                                label: 'Admin Reset',
                                data: adminResetStatus.map(status => status ? 8 : 0), // Assuming 8 hours for admin reset
                                backgroundColor: 'rgba(75, 192, 192, 0.6)', // Greenish-blue for admin reset
                                stack: 'dailyHours', // Stack with worked hours
                                borderWidth: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e0e0e0'
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value, context) => {
                                    // Only show datalabel for the 'Hours Worked' dataset
                                    if (context.dataset.label === 'Hours Worked') {
                                        return `${value.toFixed(1)}h`;
                                    }
                                    return ''; // Hide for other datasets
                                },
                                color: '#fff'
                            },
                            tooltip: {
                                callbacks: {
                                    title: (context) => context[0].label,
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toFixed(1) + 'h';
                                        return label;
                                    },
                                    footer: (context) => {
                                        const index = context[0].dataIndex;
                                        const dayLeaveStatus = leaveStatus[index];
                                        const dayAdminResetStatus = adminResetStatus[index];
                                        let footerText = [];
                                        if (dayLeaveStatus) footerText.push('Status: On Leave');
                                        if (dayAdminResetStatus) footerText.push('Status: Admin Reset');
                                        return footerText.join('\n');
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `This Week: ${percentage.toFixed(1)}% of target`,
                                color: '#e0e0e0',
                                font: {
                                    size: 14
                                }
                            },
                            'chartjs-plugin-3d': { // Plugin for 3D effect on bars (if enabled)
                                enabled: true,
                                alpha: 10,
                                beta: 10,
                                depth: 20,
                                viewDistance: 25
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...hours, 10), // Adjust max dynamically
                                title: {
                                    display: true,
                                    text: 'Hours',
                                    color: '#e0e0e0'
                                },
                                ticks: {
                                    color: '#bdbdbd'
                                },
                                grid: {
                                    color: '#424242'
                                },
                                stacked: true // Enable stacking for multiple datasets
                            },
                            x: {
                                ticks: {
                                    color: '#bdbdbd'
                                },
                                grid: {
                                    color: '#424242'
                                },
                                stacked: true // Enable stacking for multiple datasets
                            }
                        },
                        animation: {
                            duration: 2000
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching weekly attendance:', error);
                ctx.font = "16px Arial";
                ctx.fillStyle = "#e0e0e0";
                ctx.fillText("Error loading data", 10, 50);
            }
        }

        async function updateWeeklyChart() {
            const weekValue = document.getElementById('weeklyDate').value;
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/attendance/weekly?week=${weekValue}`, {
                     headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (!response.ok) {
                    console.error('Failed to fetch weekly attendance for week:', response.status);
                    return;
                }
                const data = await response.json();
                const days = data.days || [];
                const hours = data.hours || [];
                const leaveStatus = data.leaveStatus || Array(days.length).fill(false);
                const adminResetStatus = data.adminResetStatus || Array(days.length).fill(false);

                const weeklyTargetHours = days.length * 8;
                const weeklyTotal = hours.reduce((sum, hour) => sum + hour, 0);
                const percentage = weeklyTargetHours > 0 ? Math.min(100, (weeklyTotal / weeklyTargetHours) * 100) : 0;

                weeklyChart.data.labels = days;
                weeklyChart.data.datasets[0].data = hours;
                weeklyChart.data.datasets[1].data = leaveStatus.map(status => status ? 8 : 0);
                weeklyChart.data.datasets[2].data = adminResetStatus.map(status => status ? 8 : 0);

                weeklyChart.options.plugins.title.text = `Week ${weekValue}: ${percentage.toFixed(1)}% of target`;
                weeklyChart.options.scales.y.max = Math.max(...hours, 10);
                
                // Update tooltip callbacks to reflect new data (leave/reset status)
                weeklyChart.options.plugins.tooltip.callbacks.footer = (context) => {
                    const index = context[0].dataIndex;
                    const dayLeaveStatus = leaveStatus[index];
                    const dayAdminResetStatus = adminResetStatus[index];
                    let footerText = [];
                    if (dayLeaveStatus) footerText.push('Status: On Leave');
                    if (dayAdminResetStatus) footerText.push('Status: Admin Reset');
                    return footerText.join('\n');
                };

                weeklyChart.update();
            } catch (error) {
                console.error('Error fetching weekly attendance for week:', error);
            }
        }

        async function initMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            try {
                const token = localStorage.getItem('jwtToken');
                const currentMonth = document.getElementById('monthlyDate').value;
                const response = await fetch(`/api/attendance/monthly?month=${currentMonth}`, {
                     headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (!response.ok) {
                    console.error('Failed to fetch monthly attendance:', response.status);
                    ctx.font = "16px Arial";
                    ctx.fillStyle = "#e0e0e0";
                    ctx.fillText("Error loading data", 10, 50);
                    return;
                }
                const data = await response.json();
                
                const labels = data.labels || []; // e.g., ["Week 1", "Week 2"] or ["Jan 1", "Jan 2"]
                const hours = data.hours || [];

                const monthlyTargetHours = 20 * 8; // Assuming 20 working days for a generic month
                const monthlyTotal = hours.reduce((sum, hour) => sum + hour, 0);
                const percentage = monthlyTargetHours > 0 ? Math.min(100, (monthlyTotal / monthlyTargetHours) * 100) : 0;
                const monthName = new Date(currentMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });


                if (monthlyChart) monthlyChart.destroy();

                monthlyChart = new Chart(ctx, {
                    type: 'radar',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Hours Worked',
                            data: hours,
                            backgroundColor: 'rgba(255, 165, 0, 0.4)', // Orange
                            borderColor: 'rgba(255, 165, 0, 0.8)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(255, 165, 0, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(255, 165, 0, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Often best to hide legend on radar for clarity
                            },
                            datalabels: {
                                display: false // Often best to hide datalabels on radar for clarity
                            },
                            title: {
                                display: true,
                                text: `${monthName}: ${percentage.toFixed(1)}% of target`,
                                color: '#e0e0e0',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    color: '#424242'
                                },
                                grid: {
                                    color: '#424242'
                                },
                                suggestedMin: 0,
                                suggestedMax: Math.max(...hours, 50), // Adjust max dynamically
                                ticks: {
                                    display: false // Hide axis ticks for cleaner radar
                                },
                                pointLabels: {
                                    color: '#bdbdbd'
                                }
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.3,
                                backgroundColor: 'rgba(255, 165, 0, 0.2)' // Orange fill
                            }
                        },
                        animation: {
                            duration: 2000
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching monthly attendance:', error);
                ctx.font = "16px Arial";
                ctx.fillStyle = "#e0e0e0";
                ctx.fillText("Error loading data", 10, 50);
            }
        }

        async function updateMonthlyChart() {
            const monthValue = document.getElementById('monthlyDate').value;
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/attendance/monthly?month=${monthValue}`, {
                     headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (!response.ok) {
                    console.error('Failed to fetch monthly attendance for month:', response.status);
                    return;
                }
                const data = await response.json();
                const labels = data.labels || [];
                const hours = data.hours || [];
                const monthlyTargetHours = 20 * 8;
                const monthlyTotal = hours.reduce((sum, hour) => sum + hour, 0);
                const percentage = monthlyTargetHours > 0 ? Math.min(100, (monthlyTotal / monthlyTargetHours) * 100) : 0;
                const monthName = new Date(monthValue + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); // Include year for clarity

                monthlyChart.data.labels = labels;
                monthlyChart.data.datasets[0].data = hours;
                monthlyChart.options.plugins.title.text = `${monthName}: ${percentage.toFixed(1)}% of target`;
                monthlyChart.options.scales.r.suggestedMax = Math.max(...hours, 50);
                monthlyChart.update();
            } catch (error) {
                console.error('Error fetching monthly attendance for month:', error);
            }
        }
    </script>
</body>
</html>